<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNO Online</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

        :root {
            --red: #ff5252;
            --blue: #448aff;
            --green: #69f0ae;
            --yellow: #ffd740;
            --black: #2d3436;
            --bg: #1e272e;
        }

        body {
            font-family: 'Fredoka One', cursive;
            background-color: var(--bg);
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Screens --- */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .active-screen {
            display: flex;
        }

        /* --- Login/Lobby --- */
        .input-group {
            margin: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        input {
            padding: 10px 20px;
            font-size: 20px;
            border-radius: 10px;
            border: none;
            text-align: center;
            font-family: inherit;
        }

        button {
            padding: 15px 40px;
            font-size: 20px;
            font-family: inherit;
            background: linear-gradient(45deg, #ff9f43, #ee5253);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
            margin: 5px;
        }

        button:hover {
            transform: scale(1.05);
        }

        button.secondary {
            background: linear-gradient(45deg, #448aff, #69f0ae);
        }

        /* --- Game Board --- */
        #gameInfo {
            position: absolute;
            top: 20px;
            left: 20px;
            text-align: left;
            z-index: 50;
        }

        .opponents {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            position: absolute;
            top: 0;
            width: 100%;
        }

        .opponent {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 15px;
            text-align: center;
            min-width: 100px;
            transition: all 0.3s;
        }

        .opponent.active-turn {
            border: 3px solid #ffd740;
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .center-table {
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 40px;
            align-items: center;
        }

        .card-pile {
            width: 100px;
            height: 150px;
            background: #333;
            border-radius: 10px;
            border: 4px solid white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
        }

        .discard-pile {
            background: white;
            color: black;
            font-size: 40px;
            text-transform: uppercase;
            position: relative;
        }

        .active-color-indicator {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .card {
            width: 90px;
            height: 135px;
            border-radius: 10px;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.5);
            position: relative;
            box-shadow: -2px 2px 5px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s;
            user-select: none;
        }

        .card:hover {
            transform: translateY(-20px);
            z-index: 100 !important;
        }

        .card.red {
            background: var(--red);
        }

        .card.blue {
            background: var(--blue);
        }

        .card.green {
            background: var(--green);
        }

        .card.yellow {
            background: var(--yellow);
        }

        .card.black {
            background: var(--black);
            background-image: linear-gradient(135deg, red, blue, green, yellow);
        }

        .my-hand {
            position: absolute;
            bottom: 20px;
            display: flex;
            justify-content: center;
            width: 100%;
            height: 150px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .my-hand .card {
            margin-left: -40px;
        }

        .my-hand .card:first-child {
            margin-left: 0;
        }

        /* --- Modals --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 200;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .modal-content {
            background: #2d3436;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid white;
        }

        .color-options {
            display: flex;
            gap: 10px;
        }

        .color-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid white;
        }

        .action-btns {
            position: absolute;
            bottom: 200px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .uno-btn {
            background: linear-gradient(45deg, #ff5252, #ff9f43);
        }

        .catch-btn {
            background: #d63031;
            font-size: 16px;
            padding: 10px 20px;
        }

        #statusText {
            font-size: 24px;
            margin-bottom: 10px;
            color: #ffd740;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body>

    <!-- Screen 1: Login -->
    <div id="screen-login" class="screen active-screen">
        <h1>UNO ONLINE</h1>
        <div class="input-group">
            <input type="text" id="username" placeholder="Enter Nickname" maxlength="10">
        </div>
        <div class="input-group">
            <button onclick="createGame()">Create New Game</button>
            <div style="display:flex; gap:10px;">
                <input type="text" id="roomCodeInput" placeholder="Room Code"
                    style="width: 120px; text-transform:uppercase;">
                <button class="secondary" onclick="joinGame()">Join</button>
            </div>
        </div>
    </div>

    <!-- Screen 2: Lobby -->
    <div id="screen-lobby" class="screen">
        <h1>Lobby</h1>
        <h2 id="lobbyRoomCode" style="color:#ffd740; letter-spacing: 2px;">CODE: ----</h2>
        <div id="lobbyPlayerList" style="margin: 20px; font-size: 20px;"></div>
        <div id="hostControls" style="display:none;">
            <button onclick="startGame()">START GAME</button>
        </div>
        <p id="waitingMsg">Waiting for host to start...</p>
    </div>

    <!-- Screen 3: Game -->
    <div id="screen-game" class="screen">
        <div id="gameInfo">
            <div>Room: <span id="gameRoomCode"></span></div>
            <div id="actionLog" style="font-size: 14px; opacity: 0.8; margin-top: 5px;"></div>
        </div>

        <div class="opponents" id="opponentsList"></div>

        <div class="center-table">
            <div class="card-pile" onclick="drawCard()">DRAW</div>
            <div class="card discard-pile" id="discardPile">
                <span></span>
                <div id="activeColorIndicator" class="active-color-indicator"></div>
            </div>
        </div>

        <div style="position: absolute; top: 35%; width: 100%; text-align: center;">
            <h2 id="statusText">Waiting...</h2>
        </div>

        <div class="action-btns">
            <button class="uno-btn" onclick="sayUno()">UNO!</button>
            <button class="catch-btn" onclick="catchUno()">CATCH UNO!</button>
        </div>

        <div class="my-hand" id="myHand"></div>
    </div>

    <!-- Modals -->
    <div id="colorPicker" class="modal">
        <h2>Choose Color</h2>
        <div class="color-options">
            <div class="color-btn" style="background:var(--red)" onclick="pickColor('red')"></div>
            <div class="color-btn" style="background:var(--blue)" onclick="pickColor('blue')"></div>
            <div class="color-btn" style="background:var(--green)" onclick="pickColor('green')"></div>
            <div class="color-btn" style="background:var(--yellow)" onclick="pickColor('yellow')"></div>
        </div>
    </div>

    <div id="wildChallengeModal" class="modal">
        <div class="modal-content">
            <h2>Wild Draw 4 Played!</h2>
            <p id="challengeText">Player played a +4 on you.</p>
            <p>Do you want to CHALLENGE?</p>
            <p style="font-size: 14px; opacity: 0.8;">Rule: They can only play +4 if they have NO matching color.</p>
            <div style="margin-top:20px; display:flex; gap:20px; justify-content:center;">
                <button onclick="respondChallenge(true)" style="background:#ff5252">CHALLENGE</button>
                <button onclick="respondChallenge(false)" class="secondary">ACCEPT (+4)</button>
            </div>
        </div>
    </div>

    <div id="drawDecisionModal" class="modal">
        <div class="modal-content">
            <h2>You Drew:</h2>
            <div id="drawnCardDisplay" class="card" style="margin: 0 auto; margin-bottom: 20px;"></div>
            <p>Do you want to play it?</p>
            <div style="display:flex; gap:20px; justify-content:center;">
                <button onclick="finishDraw(true)">PLAY</button>
                <button onclick="finishDraw(false)" class="secondary">PASS</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myId = null;
        let myHand = [];
        let pendingCardIndex = null;
        let isDrawDecision = false;

        // --- Navigation ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
        }

        // --- Socket Events ---

        socket.on('connect', () => { myId = socket.id; });

        socket.on('gameCreated', (data) => {
            document.getElementById('lobbyRoomCode').innerText = `CODE: ${data.roomCode}`;
            document.getElementById('hostControls').style.display = 'block';
            document.getElementById('waitingMsg').style.display = 'none';
            showScreen('screen-lobby');
        });

        socket.on('joinedGame', (data) => {
            document.getElementById('lobbyRoomCode').innerText = `CODE: ${data.roomCode}`;
            if (!data.isHost) {
                document.getElementById('hostControls').style.display = 'none';
                document.getElementById('waitingMsg').innerText = "Waiting for host to start...";
                document.getElementById('waitingMsg').style.display = 'block';
            }
            showScreen('screen-lobby');
        });

        socket.on('playerList', (players) => {
            const div = document.getElementById('lobbyPlayerList');
            div.innerHTML = players.map(p => `<div>${p.name}</div>`).join('');
        });

        socket.on('gameStarted', (data) => {
            document.getElementById('gameRoomCode').innerText = data.roomCode;
            showScreen('screen-game');
            updateBoard(data);
        });

        socket.on('gameState', (data) => updateBoard(data));
        socket.on('handUpdate', (hand) => {
            myHand = hand;
            renderHand();
        });

        socket.on('challengePrompt', (data) => {
            document.getElementById('challengeText').innerText = `${data.attackerName} played a +4 on you!`;
            document.getElementById('wildChallengeModal').style.display = 'flex';
        });

        socket.on('drawChoice', (data) => {
            // Show modal to play or pass
            isDrawDecision = true;
            const c = data.card;
            // Render card in modal
            const cardDiv = document.getElementById('drawnCardDisplay');
            cardDiv.className = `card ${c.color}`;
            cardDiv.innerHTML = `<span>${getDisplayValue(c.value)}</span>`;
            document.getElementById('drawDecisionModal').style.display = 'flex';
        });

        socket.on('actionLog', (data) => {
            const log = document.getElementById('actionLog');
            log.innerText = data.msg;
            setTimeout(() => log.innerText = '', 3000);
        });

        socket.on('gameOver', (data) => {
            alert(`${data.winner} WINS!`);
            location.reload();
        });

        socket.on('errorMsg', (msg) => alert(msg));

        // --- Actions ---

        function createGame() {
            const name = document.getElementById('username').value;
            if (!name) return alert("Enter name!");
            socket.emit('createGame', { paramName: name });
        }

        function joinGame() {
            const name = document.getElementById('username').value;
            const code = document.getElementById('roomCodeInput').value;
            if (!name || !code) return alert("Enter name and code!");
            socket.emit('joinGame', { roomCode: code, paramName: name });
        }

        function startGame() {
            socket.emit('startGame');
        }

        function drawCard() {
            socket.emit('drawCard');
        }

        function sayUno() {
            socket.emit('sayUno');
        }

        function catchUno() {
            socket.emit('catchUno');
        }

        function renderHand() {
            const div = document.getElementById('myHand');
            div.innerHTML = '';
            myHand.forEach((card, index) => {
                const el = document.createElement('div');
                el.className = `card ${card.color}`;
                el.onclick = () => tryPlayCard(index);
                el.innerHTML = `<span>${getDisplayValue(card.value)}</span>`;
                div.appendChild(el);
            });
        }

        function updateBoard(data) {
            // Opponents
            const oppDiv = document.getElementById('opponentsList');
            oppDiv.innerHTML = '';
            data.players.forEach(p => {
                if (p.id === myId) return;
                const d = document.createElement('div');
                d.className = `opponent ${p.isTurn ? 'active-turn' : ''}`;
                d.innerHTML = `<div>${p.name}</div><div style="font-size:24px">ðŸ‚  ${p.cardCount}</div>${p.saidUno ? '<div style="color:red; font-weight:bold;">UNO!</div>' : ''}`;
                oppDiv.appendChild(d);
            });

            // Status
            const myTurn = data.currentPlayer === myId;
            document.getElementById('statusText').innerText = myTurn ? "YOUR TURN!" : "Waiting...";
            document.getElementById('statusText').style.color = myTurn ? "#69f0ae" : "white";

            // Discard Pile
            const discard = document.getElementById('discardPile');
            const c = data.topCard;
            let colorClass = c.color;
            if (c.color === 'black' && data.activeColor) colorClass = data.activeColor; // Show chosen color
            else if (c.color === 'black') colorClass = 'black';

            discard.className = `card discard-pile ${colorClass}`;
            discard.innerHTML = `<span>${getDisplayValue(c.value)}</span>`;

            // Active Color dot
            const ac = document.getElementById('activeColorIndicator');
            ac.style.background = data.activeColor || 'transparent';
        }

        function getDisplayValue(val) {
            if (val === 'skip') return 'ðŸš«';
            if (val === 'reverse') return 'â‡„';
            if (val === 'draw2') return '+2';
            if (val === 'wild') return 'ðŸŒˆ';
            if (val === 'wild_draw4') return '+4';
            return val;
        }

        function tryPlayCard(index) {
            const card = myHand[index];
            if (card.color === 'black') {
                pendingCardIndex = index;
                document.getElementById('colorPicker').style.display = 'flex';
            } else {
                socket.emit('playCard', { cardIndex: index });
            }
        }

        function pickColor(color) {
            document.getElementById('colorPicker').style.display = 'none';

            if (isDrawDecision) {
                socket.emit('finishDrawTurn', { play: true, chosenColor: color });
                document.getElementById('drawDecisionModal').style.display = 'none';
                isDrawDecision = false;
            } else if (pendingCardIndex !== null) {
                socket.emit('playCard', { cardIndex: pendingCardIndex, chosenColor: color });
                pendingCardIndex = null;
            }
        }

        function respondChallenge(doChallenge) {
            socket.emit('respondChallenge', { challenge: doChallenge });
            document.getElementById('wildChallengeModal').style.display = 'none';
        }

        function finishDraw(play) {
            if (play) {
                // Check if it's wild, we need color
                // We don't have the card object easily here unless we saved it from event
                // But wait, if we click Play, we need to pick color if Wild.
                // Let's assume we can check the DOM element? 
                // Or we saved it? We rendered it with class.
                const cardDiv = document.getElementById('drawnCardDisplay');
                if (cardDiv.classList.contains('black')) {
                    // It's wild
                    // Close this modal, open color picker
                    // Set flag so color picker knows to emit 'finishDrawTurn'
                    // isDrawDecision already set to true
                    document.getElementById('colorPicker').style.display = 'flex';
                    return; // Don't emit yet
                }
                socket.emit('finishDrawTurn', { play: true });
            } else {
                socket.emit('finishDrawTurn', { play: false });
            }
            document.getElementById('drawDecisionModal').style.display = 'none';
            isDrawDecision = false;
        }

    </script>
</body>

</html>