<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UNO Online</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* Palette */
            --bg-color: #1e272e;
            --surface: #2d3436;
            --primary: #ffd740;
            --red: #ff5555;
            --blue: #55aaff;
            --green: #55ff55;
            --yellow: #ffaa00;

            /* Dimensions */
            --card-w-desktop: 100px;
            --card-h-desktop: 150px;
            --card-w-mobile: 70px;
            --card-h-mobile: 105px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: var(--bg-color);
            color: white;
            font-family: 'Nunito', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Screens --- */
        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .active-screen {
            display: flex;
            opacity: 1;
        }

        /* --- Typography --- */
        h1,
        h2 {
            font-family: 'Fredoka One', cursive;
            margin: 5px 0;
        }

        .text-accent {
            color: var(--primary);
            text-shadow: 0 0 10px rgba(255, 215, 64, 0.5);
        }

        /* --- Components: Inputs & Buttons --- */
        input {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            padding: 15px;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            text-align: center;
            width: 250px;
            margin-bottom: 10px;
            outline: none;
            transition: 0.2s;
        }

        input:focus {
            border-color: var(--primary);
            background: rgba(0, 0, 0, 0.2);
        }

        button {
            background: var(--primary);
            color: #d35400;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 20px;
            font-weight: 900;
            cursor: pointer;
            box-shadow: 0 6px 0 #d35400;
            transform: translateY(0);
            transition: 0.1s;
            min-width: 150px;
            margin: 5px;
        }

        button:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 transparent;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        button.btn-secondary {
            background: #34495e;
            /* Dark Blue */
            color: white;
            box-shadow: 0 6px 0 #2c3e50;
        }

        /* --- Components: Toast --- */
        #toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            pointer-events: none;
        }

        .toast {
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            margin-top: 10px;
            animation: fadeInOut 2s forwards;
            display: block;
            text-align: center;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }

            15% {
                opacity: 1;
                transform: translateY(0);
            }

            85% {
                opacity: 1;
            }

            100% {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* --- GAME LAYOUT (Grid) --- */
        #game-layout {
            display: grid;
            grid-template-rows: 80px 1fr 180px;
            /* Header, Center, Footer */
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Header: Opponents */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            /* Centered opponents */
            padding: 0 20px;
            background: rgba(0, 0, 0, 0.2);
            gap: 20px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .opponent {
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.7;
            transition: 0.3s;
            min-width: 70px;
        }

        .opponent.active-turn {
            opacity: 1;
            transform: scale(1.1);
        }

        .opponent-avatar {
            width: 40px;
            height: 40px;
            background: #bdc3c7;
            color: #2c3e50;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            border: 2px solid transparent;
            position: relative;
        }

        .opponent.active-turn .opponent-avatar {
            background: var(--primary);
            border-color: white;
            box-shadow: 0 0 15px var(--primary);
        }

        .opponent-card-count {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #ff5555;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            border: 1px solid white;
        }

        .opponent-name {
            font-size: 12px;
            margin-top: 5px;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Status Indicator Overlay */
        .status-overlay {
            position: absolute;
            top: 100px;
            /* Below top bar */
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 5;
        }

        #statusText {
            font-family: 'Fredoka One';
            font-size: 28px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        /* Center Board */
        .center-board {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            position: relative;
        }

        /* Card Piles */
        .pile-area {
            width: var(--card-w-desktop);
            height: var(--card-h-desktop);
            position: relative;
        }

        /* Draw Pile */
        .draw-pile {
            width: 100%;
            height: 100%;
            background: #2c3e50;
            border: 3px solid #ecf0f1;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: #7f8c8d;
            transition: transform 0.1s;
        }

        .draw-pile:active {
            transform: scale(0.95);
        }

        .draw-pile::after {
            content: "UNO";
            opacity: 0.2;
            transform: rotate(-30deg);
            font-family: 'Fredoka One';
            font-size: 30px;
        }

        /* Discard Pile */
        .discard-pile {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Active Color Dot */
        .color-dot {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            z-index: 20;
            background: transparent;
            transition: background 0.3s;
        }

        /* Footer: Hand */
        .bottom-bar {
            display: flex;
            align-items: flex-end;
            padding-bottom: 20px;
            overflow-x: auto;
            /* Scrollable */
            padding-left: 50%;
            /* Center start */
            margin-left: -50%;
            /* Hackish centering fix or JS shift? Used Flex justify if fits */
            justify-content: flex-start;
            /* Default scroll */
            padding: 10px 20px 20px 20px;
            gap: 5px;
            /* Minimal gap */
        }

        /* Hand Container Wrapper to fix scroll centering issues */
        .hand-wrapper {
            display: flex;
            width: 100%;
            height: 100%;
            overflow-x: auto;
            justify-content: center;
            /* Center if few cards, start if many */
        }

        .hand-inner {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            /* CLEAN SPACING - Positive value */
            padding: 0 40px;
            /* Side padding */
        }

        /* Hide scrollbar */
        .hand-wrapper::-webkit-scrollbar {
            height: 6px;
        }

        .hand-wrapper::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        /* --- CARD DESIGN (CSS ONLY) --- */
        .card {
            width: var(--card-w-desktop);
            height: var(--card-h-desktop);
            background: white;
            border-radius: 10px;
            box-shadow: -2px 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.2s, z-index 0s;
            user-select: none;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-30px);
            z-index: 100;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }

        /* Card Colors */
        .bg-red {
            background: var(--red);
            color: var(--red);
        }

        .bg-blue {
            background: var(--blue);
            color: var(--blue);
        }

        .bg-green {
            background: var(--green);
            color: var(--green);
        }

        .bg-yellow {
            background: var(--yellow);
            color: var(--yellow);
        }

        .bg-black {
            background: #2d3436;
            color: white;
            background: radial-gradient(circle, #444 20%, #000 100%);
        }

        /* Special Wild Gradient Border/Effect */
        .bg-black .inner-oval {
            border: 2px solid white;
        }

        .inner-oval {
            position: absolute;
            top: 10%;
            bottom: 10%;
            left: 10%;
            right: 10%;
            background: white;
            border-radius: 50%;
            transform: rotate(-30deg);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .bg-black .inner-oval {
            background: white;
            /* Or rainbow? Keep simple */
        }

        .card-symbol {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            font-family: 'Fredoka One';
            z-index: 2;
            color: inherit;
            /* Takes from parent usually, but text inside oval needs specific */
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.1);
        }

        /* Fix text color inside the white oval */
        .bg-red .card-symbol {
            color: var(--red);
        }

        .bg-blue .card-symbol {
            color: var(--blue);
        }

        .bg-green .card-symbol {
            color: var(--green);
        }

        .bg-yellow .card-symbol {
            color: var(--yellow);
        }

        .bg-black .card-symbol {
            background: linear-gradient(45deg, var(--red), var(--blue), var(--green), var(--yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 50px;
        }

        .corner-idx {
            position: absolute;
            font-size: 16px;
            font-weight: bold;
            color: white;
            padding: 4px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .corner-tl {
            top: 2px;
            left: 4px;
        }

        .corner-br {
            bottom: 2px;
            right: 4px;
            transform: rotate(180deg);
        }

        /* --- Action Buttons (UNO / Catch) --- */
        .action-area {
            position: absolute;
            right: 20px;
            bottom: 220px;
            /* Above hand */
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 50;
        }

        .btn-round {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            padding: 0;
            min-width: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.4;
            pointer-events: none;
            transition: 0.3s;
        }

        .btn-active {
            opacity: 1;
            pointer-events: all;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        /* --- MOBILE --- */
        @media (max-width: 600px) {
            :root {
                --card-w-desktop: 70px;
                --card-h-desktop: 100px;
            }

            .center-board {
                gap: 15px;
            }

            .action-area {
                bottom: 160px;
                right: 10px;
            }

            .btn-round {
                width: 50px;
                height: 50px;
                font-size: 12px;
            }

            h1 {
                font-size: 24px;
            }

            #statusText {
                font-size: 18px;
            }

            .hand-inner {
                gap: 5px;
            }

            .card:hover {
                transform: translateY(-15px);
            }
        }

        /* --- Modals --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeModal 0.2s;
        }

        @keyframes fadeModal {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-box {
            background: var(--surface);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 90%;
            border: 2px solid white;
        }

        .color-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .color-choice {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            cursor: pointer;
            transition: 0.1s;
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        .color-choice:active {
            transform: scale(0.9);
        }
    </style>
</head>

<body>

    <div id="toast-container"></div>

    <!-- Screen: Login -->
    <div id="screen-login" class="screen active-screen">
        <h1 class="text-accent" style="font-size: 60px;">UNO</h1>
        <p style="margin-bottom: 30px; font-weight: bold;">ONLINE MULTIPLAYER</p>

        <input type="text" id="username" placeholder="Nickname" maxlength="12">
        <button onclick="createGame()">Create Room</button>

        <div style="margin-top:20px; display: flex; gap: 10px; align-items: center;">
            <input type="text" id="roomCode" placeholder="Enter Code"
                style="width: 140px; margin:0; text-transform:uppercase;">
            <button class="btn-secondary" style="margin:0; min-width:auto;" onclick="joinGame()">Join</button>
        </div>
    </div>

    <!-- Screen: Lobby -->
    <div id="screen-lobby" class="screen">
        <h2>Lobby</h2>
        <div style="background: rgba(255,255,255,0.1); padding: 15px 30px; border-radius: 15px; text-align: center; margin: 20px; cursor: pointer;"
            onclick="copyCode()" title="Click to Copy">
            <small>ROOM CODE</small>
            <div id="lobbyCodeDisplay" class="text-accent" style="font-size: 32px; letter-spacing: 3px;">Loading...
            </div>
        </div>

        <div id="lobbyList"
            style="display: flex; flex-direction: column; gap: 10px; width: 300px; margin-bottom: 20px;">
            <!-- Player List -->
        </div>

        <div id="hostArea" style="display: none;">
            <button onclick="startGame()">START GAME</button>
        </div>
        <p id="waitText">Waiting for host...</p>
    </div>

    <!-- Screen: Game -->
    <div id="screen-game" class="screen">
        <div id="game-layout">

            <!-- Headers -->
            <div class="top-bar" id="opponentsBar">
                <!-- Opponent Avatars -->
            </div>

            <!-- Status Msg -->
            <div class="status-overlay">
                <div id="statusText">Connecting...</div>
                <!-- Copy Room Code Helper in Game -->
                <div style="font-size: 12px; opacity: 0.5; margin-top: 5px; cursor: pointer;" onclick="copyCode()">Room:
                    <span id="gameCodeDisplay"></span> ❐</div>
            </div>

            <!-- Center -->
            <div class="center-board">
                <div class="pile-area">
                    <div class="draw-pile" onclick="drawCard()"></div>
                </div>
                <div class="pile-area">
                    <div class="discard-pile" id="discardPile"></div>
                    <div class="color-dot" id="activeColorDot"></div>
                </div>
            </div>

            <!-- Actions -->
            <div class="action-area">
                <button id="btnUno" class="btn-round"
                    style="background: linear-gradient(135deg, #000, #444); border: 2px solid #ed8936; color: #ed8936;"
                    onclick="sayUno()">UNO</button>
                <button id="btnCatch" class="btn-round" style="background: #e74c3c; color: white;"
                    onclick="catchUno()">CATCH</button>
            </div>

            <!-- Hand -->
            <div class="bottom-bar">
                <div class="hand-wrapper">
                    <div class="hand-inner" id="myHand">
                        <!-- My Cards -->
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modals -->
    <div id="colorModal" class="modal">
        <div class="modal-box">
            <h3>Choose Color</h3>
            <div class="color-grid">
                <div class="color-choice" style="background: var(--red);" onclick="pickColor('red')"></div>
                <div class="color-choice" style="background: var(--blue);" onclick="pickColor('blue')"></div>
                <div class="color-choice" style="background: var(--green);" onclick="pickColor('green')"></div>
                <div class="color-choice" style="background: var(--yellow);" onclick="pickColor('yellow')"></div>
            </div>
        </div>
    </div>

    <div id="wildDraw4Modal" class="modal">
        <div class="modal-box">
            <h3 style="color: var(--red);">Wild Draw 4 Attack!</h3>
            <p id="challengeMsg">Opponent played +4.</p>
            <p style="font-size: 14px; margin-bottom: 20px;">Challenge them if you think they have the matching color!
            </p>
            <button onclick="respondChallenge(true)" style="background: #e74c3c;">Challenge</button>
            <button class="btn-secondary" onclick="respondChallenge(false)">Accept (+4)</button>
        </div>
    </div>

    <div id="drawDecisionModal" class="modal">
        <div class="modal-box">
            <h3>Playable Card Drawn!</h3>
            <div id="drawPreview" style="display: flex; justify-content: center; margin: 20px;"></div>
            <button onclick="finalizeDraw(true)">Play It</button>
            <button class="btn-secondary" onclick="finalizeDraw(false)">Keep It</button>
        </div>
    </div>

    <div id="victoryModal" class="modal">
        <div class="modal-box">
            <h1 class="text-accent" style="font-size: 50px;">VICTORY!</h1>
            <h2 id="winnerText">Name wins!</h2>
            <br>
            <button onclick="location.reload()">Return to Menu</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myId = null;
        let myHand = [];
        let currentRoomCode = "";

        // --- Navigation ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
        }

        function toast(msg) {
            const c = document.getElementById('toast-container');
            const d = document.createElement('div');
            d.className = 'toast';
            d.innerText = msg;
            c.appendChild(d);
            setTimeout(() => d.remove(), 2100);
        }

        function copyCode() {
            navigator.clipboard.writeText(currentRoomCode).then(() => toast("Code Copied!")).catch(() => toast("Error Copying"));
        }

        // --- Socket Events ---
        socket.on('connect', () => myId = socket.id);

        socket.on('gameCreated', (data) => {
            currentRoomCode = data.roomCode;
            document.getElementById('lobbyCodeDisplay').innerText = data.roomCode;
            document.getElementById('hostArea').style.display = 'block';
            document.getElementById('waitText').style.display = 'none';
            showScreen('screen-lobby');
        });

        socket.on('joinedGame', (data) => {
            currentRoomCode = data.roomCode;
            document.getElementById('lobbyCodeDisplay').innerText = data.roomCode;
            document.getElementById('hostArea').style.display = 'none';
            document.getElementById('waitText').style.display = 'block';
            showScreen('screen-lobby');
        });

        socket.on('playerList', (list) => {
            const div = document.getElementById('lobbyList');
            div.innerHTML = list.map(p => `
                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between;">
                    <span>${p.name}</span>
                    ${p.id === myId ? '<span style="opacity:0.5">(You)</span>' : ''}
                </div>
            `).join('');
        });

        socket.on('gameStarted', (state) => {
            document.getElementById('gameCodeDisplay').innerText = currentRoomCode;
            showScreen('screen-game');
            updateBoard(state);
        });

        socket.on('gameState', updateBoard);
        socket.on('handUpdate', (hand) => {
            myHand = hand;
            renderHand();
            checkButtons();
        });

        // --- Modals ---
        let pendingCardIdx = null; // For Wild color pick
        let isDrawAction = false; // Distinguish play vs draw-play choice

        socket.on('challengePrompt', (d) => {
            document.getElementById('challengeMsg').innerText = `${d.attackerName} played +4 on you.`;
            document.getElementById('wildDraw4Modal').style.display = 'flex';
        });

        socket.on('drawChoice', (d) => {
            const preview = document.getElementById('drawPreview');
            preview.innerHTML = '';
            preview.appendChild(createCardEl(d.card));
            document.getElementById('drawDecisionModal').style.display = 'flex';
        });

        socket.on('gameOver', (d) => {
            document.getElementById('winnerText').innerText = d.winner;
            document.getElementById('victoryModal').style.display = 'flex';
        });

        socket.on('actionLog', (d) => toast(d.msg));
        socket.on('errorMsg', (msg) => alert(msg));


        // --- Actions ---
        function createGame() {
            const n = document.getElementById('username').value.trim();
            if (!n) return alert("Nickname required");
            socket.emit('createGame', { paramName: n });
        }
        function joinGame() {
            const n = document.getElementById('username').value.trim();
            const c = document.getElementById('roomCode').value.trim();
            if (!n || !c) return alert("Nickname and Code required");
            socket.emit('joinGame', { paramName: n, roomCode: c });
        }
        function startGame() { socket.emit('startGame'); }
        function drawCard() { socket.emit('drawCard'); }
        function sayUno() {
            socket.emit('sayUno');
            document.getElementById('btnUno').classList.remove('btn-active');
        }
        function catchUno() { socket.emit('catchUno'); }

        function playCardAttempt(idx) {
            const card = myHand[idx];
            if (card.color === 'black') {
                pendingCardIdx = idx;
                isDrawAction = false;
                document.getElementById('colorModal').style.display = 'flex';
            } else {
                socket.emit('playCard', { cardIndex: idx });
            }
        }

        function pickColor(c) {
            document.getElementById('colorModal').style.display = 'none';
            if (isDrawAction) {
                // Was form draw choice
                socket.emit('finishDrawTurn', { play: true, chosenColor: c });
                document.getElementById('drawDecisionModal').style.display = 'none';
            } else {
                if (pendingCardIdx !== null) {
                    socket.emit('playCard', { cardIndex: pendingCardIdx, chosenColor: c });
                }
            }
        }

        function finalizeDraw(play) {
            if (play) {
                // Check if wild
                const previewCard = document.getElementById('drawPreview').firstElementChild;
                // Hacky check or just robust: logic
                // If the modal is showing a black card
                if (previewCard && previewCard.className.includes('bg-black')) {
                    isDrawAction = true;
                    document.getElementById('colorModal').style.display = 'flex';
                    return; // Wait for color
                }
                socket.emit('finishDrawTurn', { play: true });
            } else {
                socket.emit('finishDrawTurn', { play: false });
            }
            document.getElementById('drawDecisionModal').style.display = 'none';
        }

        function respondChallenge(doCh) {
            socket.emit('respondChallenge', { challenge: doCh });
            document.getElementById('wildDraw4Modal').style.display = 'none';
        }


        // --- Rendering ---
        function updateBoard(state) {
            if (!state.roomCode) return; // Empty state

            // 1. Status Text
            const isMyTurn = state.currentPlayer === myId;
            const turnPlayer = state.players.find(p => p.id === state.currentPlayer);
            const statusEl = document.getElementById('statusText');

            if (isMyTurn) {
                statusEl.innerText = "YOUR TURN";
                statusEl.style.color = "#55ff55";
            } else {
                statusEl.innerText = `${turnPlayer ? turnPlayer.name : 'Opponent'}'s Turn`;
                statusEl.style.color = "white";
            }

            // 2. Opponents Bar
            const oppBar = document.getElementById('opponentsBar');
            oppBar.innerHTML = '';
            state.players.forEach(p => {
                if (p.id === myId) return;

                const initials = p.name.substring(0, 2).toUpperCase();
                const div = document.createElement('div');
                div.className = `opponent ${p.isTurn ? 'active-turn' : ''}`;
                div.innerHTML = `
                    <div class="opponent-avatar">
                        ${initials}
                        <div class="opponent-card-count">${p.cardCount}</div>
                    </div>
                    <div class="opponent-name">${p.name}</div>
                    ${p.saidUno ? '<span style="font-size:10px; color:gold;">UNO!</span>' : ''}
                `;
                oppBar.appendChild(div);
            });

            // 3. Discard Pile
            const discEl = document.getElementById('discardPile');
            discEl.innerHTML = '';
            if (state.topCard) {
                // We need to show the visual color if it's black active
                let visualCard = { ...state.topCard }; // copy
                let isBlack = visualCard.color === 'black'; // True for fresh Wilds

                // If it is black on the pile, we often want to visually indicate it.
                // But the 'activeColorDot' handles the state.
                // Let's just render the card.
                discEl.appendChild(createCardEl(visualCard, false));
            }

            // 4. Dot
            const dot = document.getElementById('activeColorDot');
            if (state.activeColor) {
                dot.style.background = `var(--${state.activeColor})`;
                dot.style.display = 'block';
            } else {
                dot.style.display = 'none';
            }

            // 5. Catch Logic
            let canCatch = false;
            state.players.forEach(p => {
                if (p.id !== myId && p.cardCount === 1 && !p.saidUno) canCatch = true;
            });
            const btnCatch = document.getElementById('btnCatch');
            if (canCatch) btnCatch.classList.add('btn-active');
            else btnCatch.classList.remove('btn-active');
        }

        function renderHand() {
            const h = document.getElementById('myHand');
            h.innerHTML = '';
            myHand.forEach((c, i) => {
                const el = createCardEl(c);
                el.onclick = () => playCardAttempt(i);
                h.appendChild(el);
            });
        }

        function checkButtons() {
            const btn = document.getElementById('btnUno');
            if (myHand.length > 0 && myHand.length <= 2) btn.classList.add('btn-active');
            else btn.classList.remove('btn-active');
        }

        // Helper to create Card Element
        function createCardEl(cardObj, interactive = true) {
            const el = document.createElement('div');
            // Safely handle colors
            let colorClass = 'bg-black';
            if (['red', 'blue', 'green', 'yellow'].includes(cardObj.color)) colorClass = `bg-${cardObj.color}`;

            el.className = `card ${colorClass}`;

            // Format Value
            let displayVal = cardObj.value;
            if (displayVal === 'skip') displayVal = '⊘';
            if (displayVal === 'reverse') displayVal = '⇄';
            if (displayVal === 'draw2') displayVal = '+2';
            if (displayVal === 'wild') displayVal = 'W';
            if (displayVal === 'wild_draw4') displayVal = '+4';

            el.innerHTML = `
                <div class="corner-idx corner-tl">${displayVal}</div>
                <div class="inner-oval">
                    <div class="card-symbol">${displayVal}</div>
                </div>
                <div class="corner-idx corner-br">${displayVal}</div>
            `;
            return el;
        }

    </script>
</body>

</html>